<%# views/pages/orders/checkout.ejs %>

<div class="container my-5">
    <h1 class="mb-4"><%= title %></h1>

    <% if (!cart || items.length === 0) { %>
        <div class="alert alert-warning" role="alert">
            Giỏ hàng của bạn đang trống. Vui lòng <a href="/products" class="alert-link">thêm sản phẩm</a> vào giỏ trước khi thanh toán.
        </div>
    <% } else { %>
        <div class="row">
            <div class="col-md-7 col-lg-8">
                <h4 class="mb-3">Địa chỉ giao hàng</h4>
                <form action="/orders/place" method="POST" class="needs-validation" novalidate>
                    <% if (typeof csrfToken !== 'undefined' && csrfToken) { %>
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
                    <% } %>
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="fullName" class="form-label">Họ và tên</label>
                            <input type="text" class="form-control" id="fullName" name="fullName" placeholder="" value="<%= userAddress && userAddress.fullName ? userAddress.fullName : (currentUser && currentUser.fullName ? currentUser.fullName : '') %>" required>
                            <div class="invalid-feedback">
                                Vui lòng nhập họ tên.
                            </div>
                        </div>

                        <div class="col-12">
                            <label for="phone" class="form-label">Số điện thoại</label>
                            <input type="tel" class="form-control" id="phone" name="phone" placeholder="" value="<%= userAddress && userAddress.phone ? userAddress.phone : (currentUser && currentUser.phone ? currentUser.phone : '') %>" required>
                            <div class="invalid-feedback">
                                Vui lòng nhập số điện thoại.
                            </div>
                        </div>

                        <div class="col-12">
                            <label for="street" class="form-label">Địa chỉ</label>
                            <input type="text" class="form-control" id="street" name="street" placeholder="Số nhà, tên đường, phường/xã" value="<%= userAddress && userAddress.street ? userAddress.street : '' %>" required>
                            <div class="invalid-feedback">
                                Vui lòng nhập địa chỉ.
                            </div>
                        </div>

                        <div class="col-md-5">
                            <label for="city" class="form-label">Tỉnh/Thành phố</label>
                            <input type="text" class="form-control" id="city" name="city" placeholder="" value="<%= userAddress && userAddress.city ? userAddress.city : '' %>" required>
                            <div class="invalid-feedback">
                                Vui lòng nhập tỉnh/thành phố.
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label for="country" class="form-label">Quốc gia</label>
                            <input type="text" class="form-control" id="country" name="country" placeholder="" value="<%= userAddress && userAddress.country ? userAddress.country : 'Việt Nam' %>" required>
                            <div class="invalid-feedback">
                                Vui lòng nhập quốc gia.
                            </div>
                        </div>

                        <div class="col-md-3">
                            <label for="postalCode" class="form-label">Mã bưu điện</label>
                            <input type="text" class="form-control" id="postalCode" name="postalCode" placeholder="" value="<%= userAddress && userAddress.postalCode ? userAddress.postalCode : '' %>">
                            <div class="invalid-feedback">
                                Mã bưu điện không hợp lệ.
                            </div>
                        </div>
                    </div>

                    <div class="form-check mt-3">
                        <input type="checkbox" class="form-check-input" id="saveAddress" name="saveAddress" checked>
                        <label class="form-check-label" for="saveAddress">Lưu địa chỉ này cho lần mua sau</label>
                    </div>

                    <hr class="my-4">

                    <h4 class="mb-3">Phương thức thanh toán</h4>
                    <div class="my-3">
                        <div class="form-check">
                            <input id="cod" name="paymentMethod" type="radio" class="form-check-input" value="COD" checked required>
                            <label class="form-check-label" for="cod">Thanh toán khi nhận hàng (COD)</label>
                        </div>
                        <!-- Add other payment methods here if needed -->
                    </div>

                    <hr class="my-4">

                    <button class="w-100 btn btn-primary btn-lg" type="submit">Đặt hàng</button>
                </form>
            </div>

            <div class="col-md-5 col-lg-4 order-md-last">
                <h4 class="d-flex justify-content-between align-items-center mb-3">
                    <span class="text-primary">Giỏ hàng của bạn</span>
                    <span class="badge bg-primary rounded-pill"><%= items.length %></span>
                </h4>
                <ul class="list-group mb-3">
                    <% items.forEach(item => { %>
                        <li class="list-group-item d-flex justify-content-between lh-sm">
                            <div>
                                <h6 class="my-0"><%= item.name %></h6>
                                <small class="text-muted">Số lượng: <%= item.quantity %></small>
                            </div>
                            <span class="text-muted"><%- formatPrice(item.price * item.quantity) %></span>
                        </li>
                    <% }); %>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Tổng cộng (VND)</span>
                        <strong><%- formatPrice(totalAmount) %></strong>
                    </li>
                </ul>
                <div class="text-center">
                    <a href="/cart" class="btn btn-outline-secondary">Quay lại giỏ hàng</a>
                </div>
            </div>
        </div>
    <% } %>
</div>

<script>
// Example starter JavaScript for disabling form submissions if there are invalid fields
(function () {
  'use strict'

  // Fetch all the forms we want to apply custom Bootstrap validation styles to
  var forms = document.querySelectorAll('.needs-validation')

  // Loop over them and prevent submission
  Array.prototype.slice.call(forms)
    .forEach(function (form) {
      form.addEventListener('submit', function (event) {
        if (!form.checkValidity()) {
          event.preventDefault()
          event.stopPropagation()
        }

        form.classList.add('was-validated')
      }, false)
    })
})()
</script>
